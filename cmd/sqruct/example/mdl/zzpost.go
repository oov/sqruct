// DO NOT EDIT. This file was auto-generated by Sqruct.

package mdl

import (
	"time"

	"github.com/oov/q"
	"github.com/oov/sqruct"
)

// Post represents the following table.
// 	CREATE TABLE "post"(
// 		"id" INTEGER PRIMARY KEY,
// 		"accountid" INTEGER NOT NULL,
// 		"at" DATETIME NOT NULL,
// 		"message" VARCHAR(8125) NOT NULL,
// 		FOREIGN KEY (accountid) REFERENCES account(id) ON DELETE CASCADE
// 	);
type Post struct {
	ID        int64     `mdl:"pk,notnull,uniq,default,autoincr"`
	AccountID int64     `mdl:"fk,notnull"`
	At        time.Time `mdl:"notnull"`
	Message   string    `mdl:"notnull"`
}

func GetPost(db sqruct.DB, id int64) (*Post, error) {
	b, tbl := zzPost{}.SelectBuilder()
	sql, args := b.Where(
		q.Eq(tbl.C("id"), id),
	).ToSQL()
	var t Post
	err := db.QueryRow(sql, args...).Scan(zzPost{}.Pointers(&t))
	if err != nil {
		return nil, err
	}
	return &t, nil
}

func (t *Post) GetAccount(db sqruct.DB) (*Account, error) {
	b, tbl := zzAccount{}.SelectBuilder()
	sql, args := b.Where(
		q.Eq(tbl.C("id"), t.AccountID),
	).ToSQL()
	var ot Account
	if err := db.QueryRow(sql, args...).Scan(zzAccount{}.Pointers(&ot)...); err != nil {
		return nil, err
	}
	return &ot, nil
}

func (t *Post) SelectPostTag(db sqruct.DB) ([]PostTag, error) {
	b, tbl := zzPostTag{}.SelectBuilder()
	sql, args := b.Where(
		q.Eq(tbl.C("postid"), t.ID),
	).ToSQL()
	r, err := db.Query(sql, args...)
	if err != nil {
		return nil, err
	}
	defer r.Close()

	ot := []PostTag{}
	for r.Next() {
		var e PostTag
		if err = r.Scan(zzPostTag{}.Pointers(&e)...); err != nil {
			return nil, err
		}
		ot = append(ot, e)
	}
	if err = r.Err(); err != nil {
		return nil, err
	}
	return ot, nil
}

func (t *Post) SelectTag(db sqruct.DB) ([]Tag, []PostTag, error) {
	b, relTbl, _ := zzPost{}.SelectBuilderForTag()
	sql, args := b.Where(
		q.Eq(relTbl.C("postid"), t.ID),
	).ToSQL()
	r, err := db.Query(sql, args...)
	if err != nil {
		return nil, nil, err
	}
	defer r.Close()

	ot, rt := []Tag{}, []PostTag{}
	for r.Next() {
		var oe Tag
		var re PostTag
		if err = r.Scan(append(zzPostTag{}.Pointers(&re), zzTag{}.Pointers(&oe)...)...); err != nil {
			return nil, nil, err
		}
		ot, rt = append(ot, oe), append(rt, re)
	}
	if err = r.Err(); err != nil {
		return nil, nil, err
	}
	return ot, rt, nil
}

func (t *Post) Insert(db sqruct.DB) error {

	b, tbl := zzPost{}.InsertBuilder(t)
	if !sqruct.IsZero(t.ID) {
		sql, args := b.Set(tbl.C("id"), t.ID).ToSQL()
		_, err := db.Exec(sql, args...)
		return err
	}

	sql, args := b.ToSQL()
	r, err := db.Exec(sql, args...)
	if err != nil {
		return err
	}
	var i int64
	if i, err = r.LastInsertId(); err != nil {
		return err
	}

	t.ID = i
	return nil

}

func (t *Post) Update(db sqruct.DB) error {
	b, tbl := zzPost{}.UpdateBuilder(t)
	sql, args := b.Where(
		q.Eq(tbl.C("id"), t.ID),
	).ToSQL()
	_, err := db.Exec(sql, args...)
	return err
}

func (t *Post) Delete(db sqruct.DB) error {
	b, tbl := zzPost{}.DeleteBuilder()
	sql, args := b.Where(
		q.Eq(tbl.C("id"), t.ID),
	).ToSQL()
	_, err := db.Exec(sql, args...)
	return err
}

// zzPost represents Post table schema.
type zzPost struct{}

func (zzPost) Columns(b *q.ZSelectBuilder, t q.Table) {
	b.Column(
		t.C("id"),
		t.C("accountid"),
		t.C("at"),
		t.C("message"),
	)
}

func (zzPost) Pointers(t *Post) []interface{} {
	return []interface{}{&t.ID, &t.AccountID, &t.At, &t.Message}
}

func (zzPost) InsertBuilder(t *Post) (*q.ZInsertBuilder, q.Table) {
	tbl := q.T("post")
	return q.Insert().Into(tbl).
		Set(tbl.C("accountid"), t.AccountID).
		Set(tbl.C("at"), t.At).
		Set(tbl.C("message"), t.Message).
		SetDialect(q.SQLite), tbl
}

func (zzPost) SelectBuilder() (*q.ZSelectBuilder, q.Table) {
	tbl := q.T("post")
	b := q.Select().From(tbl).SetDialect(q.SQLite)
	zzPost{}.Columns(b, tbl)
	return b, tbl
}

func (zzPost) SelectBuilderForTag() (b *q.ZSelectBuilder, postTag q.Table, tag q.Table) {
	b, relTbl := zzPostTag{}.SelectBuilder()
	oTbl := q.T("tag")
	relTbl.InnerJoin(
		oTbl,
		q.Eq(relTbl.C("tagid"), oTbl.C("id")),
	)
	zzTag{}.Columns(b, oTbl)
	return b, relTbl, oTbl
}

func (zzPost) UpdateBuilder(t *Post) (*q.ZUpdateBuilder, q.Table) {
	tbl := q.T("post")
	return q.Update(tbl).
		Set(tbl.C("accountid"), t.AccountID).
		Set(tbl.C("at"), t.At).
		Set(tbl.C("message"), t.Message).
		SetDialect(q.SQLite), tbl
}

func (zzPost) DeleteBuilder() (*q.ZDeleteBuilder, q.Table) {
	tbl := q.T("post")
	return q.Delete().From(tbl).SetDialect(q.SQLite), tbl
}
